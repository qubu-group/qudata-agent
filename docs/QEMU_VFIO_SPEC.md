# QEMU VM с VFIO GPU Passthrough

> **Статус: РЕАЛИЗОВАНО**

## Архитектура

```
┌─────────────────────────────────────────────────┐
│                    Хост                          │
│  ┌─────────────────────────────────────────────┐ │
│  │              qudata-agent                   │ │
│  │  - Запускает VM при старте                  │ │
│  │  - Управляет контейнерами через SSH         │ │
│  │  - Собирает метрики из VM                   │ │
│  └─────────────────────────────────────────────┘ │
│                      │                           │
│              VFIO passthrough                    │
│                      ▼                           │
│  ┌─────────────────────────────────────────────┐ │
│  │                 QEMU VM                      │ │
│  │  ┌─────────────────────────────────────────┐ │ │
│  │  │              Docker                      │ │ │
│  │  │  ┌───────────────────────────────────┐  │ │ │
│  │  │  │       User Container              │  │ │ │
│  │  │  │  (JupyterLab, training, etc)      │  │ │ │
│  │  │  └───────────────────────────────────┘  │ │ │
│  │  └─────────────────────────────────────────┘ │ │
│  │               GPU (все)                      │ │
│  └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

## Установка

Одна команда:
```bash
curl -fsSL https://raw.githubusercontent.com/qubu-group/qudata-agent/main/install.sh | sudo bash -s -- ak-YOUR-API-KEY
```

Установщик:
1. Определяет все NVIDIA GPU
2. Настраивает IOMMU в GRUB
3. Скачивает Debian cloud image
4. Кастомизирует образ (NVIDIA driver, Docker, SSH)
5. Перезагружает систему
6. Запускает агент

## Компоненты

### internal/qemu/

- `manager.go` — управление VM lifecycle
- `ssh.go` — SSH клиент для взаимодействия с VM
- `vfio.go` — VFIO binding/unbinding GPU
- `monitor.go` — QMP протокол
- `recovery.go` — восстановление после краша

### scripts/

- `install.py` — полная автоматизация установки

## Переменные окружения

| Переменная | Описание |
|-----------|----------|
| `QUDATA_API_KEY` | API ключ |
| `QUDATA_GPU_PCI_ADDRS` | PCI адреса GPU (auto-detect) |
| `QUDATA_BASE_IMAGE` | Путь к образу VM |
| `QUDATA_DEBUG` | Debug mode без GPU |
